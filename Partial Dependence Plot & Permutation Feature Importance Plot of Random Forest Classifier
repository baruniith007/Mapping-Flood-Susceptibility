# Generate partial dependence plots with histograms for all features
fig, axs = plt.subplots(3, 2, figsize=(15, 20))  # Adjust the subplot grid based on the number of features
fig.subplots_adjust(hspace=0.2, wspace=0.25)  # Adjust space between plots
for i, feature in enumerate(X.columns):
    ax = axs[int(i / 2), i % 2]  # Determine the position of the subplot
    disp = PartialDependenceDisplay.from_estimator(best_rf, X_train, [feature], ax=ax, grid_resolution=50)
    ax.set_title(feature)  # Set title to the feature name
    # Add histogram to each PDP
    ax_hist = disp.axes_[0, 0].twinx()
    ax_hist.hist(X_train[feature], bins=30, alpha=0.3)
    ax_hist.set_ylabel("Frequency")

plt.suptitle('Partial Dependence Plots for All Features with Tuned RandomForest')
plt.show()

# Permutation feature importance
result = permutation_importance(best_rf, X_test, y_test, n_repeats=10, random_state=42, n_jobs=6)
sorted_idx = result.importances_mean.argsort()
plt.figure(figsize=(10, 6))
plt.boxplot(result.importances[sorted_idx].T, vert=False, labels=X_test.columns[sorted_idx])
plt.title('Permutation Feature Importance')
plt.xlabel('Decrease in Accuracy')
plt.show()
